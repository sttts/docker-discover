global
    daemon
    maxconn 4096
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    pidfile /var/run/haproxy.pid
#    log /dev/console local0
#    log /dev/consule local1 debug

defaults
    log global
    mode http
    
    option httplog
    option dontlognull
    option redispatch
    option  forwardfor

    timeout connect 5s
    timeout client 1m
    timeout server 1m
    
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

listen stats :1936
    stats enable
    stats hide-version
    #stats realm Haproxy\ Statistics
    stats uri /
    #stats auth Username:Password

frontend http-in
    bind *:80
{% for service in services %}
    {% if service.startswith('backend-') -%}
    acl is_for_{{service}} hdr(host) -i {{ service | replace("backend-","") | replace("-prod","") }}.backend.teamwire.eu
    use_backend {{service}} if is_for_{{service}}
    {%- endif -%}
{%- endfor %}
{% if 'backend-public-prod' in services -%}
    default_backend backend-public-prod
{%- endif %}

{% for service in services -%}
    {% if service.startswith('backend-') -%}
backend {{ service }}
    balance roundrobin
    {% for backend in services[service].backends -%}
    server {{ backend.name }} {{ backend.addr }} check inter 2s rise 3 fall 2{% endfor %}
    {% endif %}
{% endfor %}
